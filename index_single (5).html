<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>卸売 B2B EC（シングルファイル版）</title>
  <!-- このファイルは CSS と JS を内包した単一のページです。ブラウザでこの HTML を開くだけで動作します。 -->
  <style>
    /* ===== 全体のレイアウト ===== */
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; margin: 0; background: #f6f7fb; color: #222; }
    header { position: sticky; top: 0; background: #1f2937; color: #fff; padding: 10px 16px; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,.2); }
    header .row { display: flex; align-items: center; gap: 12px; }
    header h1 { font-size: 18px; margin: 0; }
    header .spacer { flex: 1; }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 360px; gap: 16px; }
    @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }

    /* チェックアウト画面では左カラムのみ表示するため、shop-view の grid は 1 カラムにする */
    #shop-view.grid-2 { grid-template-columns: 1fr; }
    .card { background: #fff; border-radius: 12px; padding: 12px; box-shadow: 0 1px 4px rgba(0,0,0,.08); }
    h2 { font-size: 16px; margin: 8px 0 12px; }
    .catalog { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px,1fr)); gap: 12px; }
    .item { display: flex; flex-direction: column; gap: 6px; }
    .item img { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; background:#e5e7eb; }
    .item .name { font-weight: 700; }
    .item .price { font-weight: 700; }
    .controls { display:flex; gap: 8px; align-items: center; margin-top: 6px; }
    .controls input[type=number]{ width: 80px; padding: 6px; border:1px solid #cfd8dc; border-radius: 8px; }
    button { padding: 8px 10px; border:0; border-radius: 8px; cursor:pointer; }
    button.primary { background: #2563eb; color:#fff; }
    button.success { background: #16a34a; color: #fff; }
    button.gray { background: #374151; color:#fff; }
    button.danger { background: #dc2626; color:#fff; }
    button.secondary { background: #4b5563; color:#fff; }
    .badge { background:#eef2ff; padding:2px 6px; border-radius:999px; font-size: 12px; }
    .cart-list .row { display:grid; grid-template-columns: 1fr auto auto auto auto; gap: 6px; align-items: center; margin: 6px 0; }
    .cart-list input[type=number] { width:80px; padding:6px; border:1px solid #cfd8dc; border-radius:8px; }
    .total { font-size: 18px; font-weight: 800; }
    .field { display:flex; flex-direction: column; gap: 4px; margin-bottom: 8px; }
    input[type=text], input[type=email], input[type=tel], textarea, input[type=number] { padding: 8px; border:1px solid #cfd8dc; border-radius: 8px; width: 100%; }
    textarea { min-height: 60px; }
    .small { font-size: 12px; color:#555; }
    .map { width: 100%; height: 260px; border: 0; border-radius: 10px; background:#e5e7eb; }
    footer { padding: 16px; text-align:center; color:#555; font-size: 12px; }
    /* 商品追加フォーム内のサイズ行 */
    #sizes-wrapper .size-row { display: flex; gap: 8px; margin-bottom: 4px; }
    #sizes-wrapper .size-row input[type=text],
    #sizes-wrapper .size-row input[type=number] { flex: 1; padding: 6px; border: 1px solid #cfd8dc; border-radius: 8px; }
    /* サイズ追加ボタンのレイアウトを調整 */
    #add-size { margin-top: 4px; }
  </style>
</head>
<body>
<header>
  <div class="row">
    <h1>卸売 B2B EC（シングルファイル）</h1>
    <div class="spacer"></div>
    <!-- カート合計をヘッダーに表示 -->
    <div style="display:flex;align-items:center;gap:8px;">
      <span>カート：<span id="cart-count">0</span> 点 / <span id="cart-total">¥0</span></span>
      <button id="btn-checkout" type="button" class="primary" style="padding:4px 8px;">カートを見る</button>
    </div>
  </div>
</header>

<div id="shop-view" class="container grid-2">
  <!-- 左カラム：カタログと商品追加 -->
  <div>
    <!-- カタログ -->
    <div class="card">
      <h2>カタログ</h2>
      <!-- 検索フォーム -->
      <div class="field" style="margin-bottom: 8px;">
        <input id="search" type="text" placeholder="商品を検索...">
      </div>
      <div id="catalog" class="catalog"></div>
    </div>
    <!-- 商品追加フォーム（管理者用）
         URL に ?admin=1 を付けた場合のみ表示されます。
         デフォルトでは非表示にして、一般の顧客がアクセスした際には商品追加が出来ないようにします。-->
    <div id="product-form-card" class="card" style="margin-top: 16px; display: none;">
      <h2>商品を追加</h2>
      <div class="field"><label>商品名 *</label><input id="product-name" type="text" placeholder="例：塩ビパイプ (VP13)"></div>
      <div class="field"><label>説明</label><textarea id="product-desc" placeholder="商品の説明を入力"></textarea></div>
      <div class="field"><label>価格 *</label><input id="product-price" type="number" min="0" step="1" placeholder="価格"></div>
      <div class="field"><label>画像</label><input id="product-image" type="file" accept="image/*"></div>
      <div class="field"><label>サイズと価格</label>
        <div id="sizes-wrapper">
          <!-- 初期のサイズ入力行は空。必要に応じて追加します -->
        </div>
        <button id="add-size" type="button" class="secondary">サイズを追加</button>
      </div>
      <div class="field">
        <button id="btn-add-product" type="button" class="primary">商品を登録</button>
      </div>
      <div class="small">※サイズが不要な場合は空欄のままで構いません。</div>
    </div>
  </div>
  <!-- 右カラムはチェックアウト画面に移動しました -->
</div>
<!-- チェックアウトビュー：カート内容と注文情報を表示 -->
<div id="checkout-view" style="display:none;">
  <div class="container">
    <!-- カート一覧 -->
    <div class="card">
      <h2>カート</h2>
      <div id="cart-list" class="cart-list"></div>
      <hr>
      <div class="row total">合計：<span id="cart-total-bottom">¥0</span></div>
      <div style="margin-top:8px;display:flex;gap:8px;">
        <button id="btn-clear" type="button" class="danger">カートを空にする</button>
        <button id="btn-back" type="button" class="secondary">戻る</button>
      </div>
    </div>
    <!-- 注文情報フォーム -->
    <div class="card" style="margin-top:12px;">
      <h2>注文情報</h2>
      <div class="field"><label>会社名 *</label><input id="company" type="text" required></div>
      <div class="field"><label>担当者名 *</label><input id="person" type="text" required></div>
      <div class="field"><label>電話番号 *</label><input id="phone" type="tel" required></div>
      <div class="field"><label>メールアドレス *</label><input id="email" type="email" required></div>
      <div class="field"><label>会社住所</label><input id="address" type="text"></div>
      <div class="field"><label>納品場所（住所や目印）</label><input id="delivery" type="text" placeholder="例：埼玉県熊谷市〇〇1-2-3 〇〇ビル3F"></div>
      <div class="field"><button id="btn-map" type="button" class="gray">地図を表示</button></div>
      <iframe id="map" class="map"></iframe>
      <hr>
      <div class="field"><label>振込先（固定）</label><input id="bank" type="text" value="住信ＳＢＩネット銀行 法人第一支店 普通2262610" readonly></div>
      <div class="field"><label>注文メールの宛先（固定）</label><input id="toEmail" type="email" value="takato@konnoshokai.co.jp" readonly></div>
      <div style="margin-top:8px;display:flex;gap:8px;"><button id="btn-send" type="button" class="primary">メールで注文送信</button></div>
      <div class="small">※ボタンを押すと、お使いのメールソフトが起動します。ご入金確認後に手配します。</div>
    </div>
  </div>
</div>
<!-- フラッシュメッセージ -->
<div id="flash" style="position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#111;color:#fff;padding:8px 12px;border-radius:8px;opacity:0;transition:.3s;"></div>
<footer>© B2B EC – Single File Edition</footer>

<!-- アプリケーションロジック -->
<script>
(() => {
  /* ===== プレースホルダー画像（ベース64） ===== */
  const PLACEHOLDER = 'data:image/png;base64,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';

  /* ===== ストレージキーの定義 ===== */
  const STORAGE_CART_KEY = 'b2bCart_spa_v3';
  const STORAGE_PRODUCTS_KEY = 'b2bProducts_spa_v3';

  /* ===== ローカルストレージ判定 ===== */
  function storageAvailable() {
    try {
      const x = '__storage_test__';
      localStorage.setItem(x, x);
      localStorage.removeItem(x);
      return true;
    } catch (e) {
      return false;
    }
  }
  const useLocal = storageAvailable();

  /* ===== 初期商品データ ===== */
  let products = [
    { name: '塩ビパイプ (VP13)', description: '標準的な塩化ビニル管。', price: 500, unit: '本', image: PLACEHOLDER, sizes: [] },
    { name: 'ポリエチレン管（20mm）', description: '飲料水用ポリエチレン管。', price: 800, unit: 'm', image: PLACEHOLDER, sizes: [] },
    { name: '真鍮ボールバルブ（20A）', description: '止水に使用する真鍮製バルブ。', price: 1200, unit: '個', image: PLACEHOLDER, sizes: [] },
    { name: '壁掛けエアコン（2.8kW）', description: '冷暖房兼用の壁掛け型エアコン。', price: 50000, unit: '台', image: PLACEHOLDER, sizes: [] },
    { name: '室外機（2.8kW）', description: '壁掛けエアコン用室外機。', price: 35000, unit: '台', image: PLACEHOLDER, sizes: [] },
    { name: '冷媒配管セット（5m）', description: '配管と断熱材のセット。', price: 6000, unit: 'セット', image: PLACEHOLDER, sizes: [] },
    { name: '高効率給湯器（エコキュート）', description: 'ヒートポンプ式高効率給湯器。', price: 200000, unit: '台', image: PLACEHOLDER, sizes: [] },
    { name: '洗面台ユニット', description: '収納付き洗面台セット。', price: 45000, unit: '台', image: PLACEHOLDER, sizes: [] },
    { name: 'システムキッチンシンク', description: 'ステンレス製キッチンシンク。', price: 60000, unit: '台', image: PLACEHOLDER, sizes: [] }
  ];

  /* ===== 補助関数 ===== */
  // 数字を通貨表記に
  function fmt(val) {
    return '¥' + Number(val).toLocaleString();
  }

  // 日本語文字列を検索用に正規化
  function normalize(str) {
    str = (str || '').toString().trim().toLowerCase();
    // 全角英数字を半角へ
    str = str.replace(/[０-９Ａ-Ｚａ-ｚ]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
    // カタカナをひらがなへ
    str = str.replace(/[\u30a1-\u30f6]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));
    // 空白類を削除
    return str.replace(/\s+/g, '');
  }

  // 商品データを保存／読み込み
  function loadProducts() {
    if (useLocal) {
      try {
        const stored = localStorage.getItem(STORAGE_PRODUCTS_KEY);
        if (stored) {
          products = JSON.parse(stored);
          return;
        }
      } catch (e) {}
      // 初期値を保存
      try {
        localStorage.setItem(STORAGE_PRODUCTS_KEY, JSON.stringify(products));
      } catch (e) {}
    }
  }
  function saveProducts() {
    if (useLocal) {
      try {
        localStorage.setItem(STORAGE_PRODUCTS_KEY, JSON.stringify(products));
      } catch (e) {}
    }
  }

  // カート取得／保存
  function getCart() {
    if (useLocal) {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_CART_KEY)) || [];
      } catch (e) { return []; }
    }
    return window.memoryCart || [];
  }
  function setCart(c) {
    if (useLocal) {
      localStorage.setItem(STORAGE_CART_KEY, JSON.stringify(c));
    } else {
      window.memoryCart = c;
    }
  }

  // カートに追加
  function addToCart(name, price, qty, size = '') {
    qty = Math.max(1, Number(qty || 1));
    price = Number(price || 0);
    const c = getCart();
    const idx = c.findIndex(x => x.name === name && Number(x.price) === price && (x.size || '') === (size || ''));
    if (idx >= 0) {
      c[idx].qty += qty;
    } else {
      c.push({ name, price, qty, size });
    }
    setCart(c);
    renderCart();
    flash('カートに追加しました');
  }

  // 数量変更
  function updateQty(name, price, size, qty) {
    qty = Math.max(1, Number(qty || 1));
    const c = getCart();
    const idx = c.findIndex(x => x.name === name && Number(x.price) === Number(price) && (x.size || '') === (size || ''));
    if (idx >= 0) {
      c[idx].qty = qty;
      setCart(c);
      renderCart();
    }
  }
  // 削除
  function removeItem(name, price, size) {
    let c = getCart().filter(x => !(x.name === name && Number(x.price) === Number(price) && (x.size || '') === (size || '')));
    setCart(c);
    renderCart();
  }
  // カートを空に
  function clearCart() {
    setCart([]);
    renderCart();
  }
  // 合計計算
  function total(c = getCart()) {
    return c.reduce((s, i) => s + Number(i.price) * Number(i.qty), 0);
  }

  // フラッシュメッセージ
  function flash(msg) {
    const el = document.getElementById('flash');
    if (!el) return;
    el.textContent = msg;
    el.style.opacity = 1;
    setTimeout(() => { el.style.opacity = 0; }, 1200);
  }

  // 地図更新
  function updateMap() {
    const q = document.getElementById('delivery').value.trim();
    if (!q) {
      alert('納品場所を入力してください');
      return;
    }
    const src = `https://www.google.com/maps?q=${encodeURIComponent(q)}&z=16&output=embed`;
    document.getElementById('map').src = src;
  }

  // 注文メール送信
  function sendEmailOrder() {
    const company = document.getElementById('company').value.trim();
    const person = document.getElementById('person').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const email = document.getElementById('email').value.trim();
    const address = document.getElementById('address').value.trim();
    const delivery = document.getElementById('delivery').value.trim();
    const bank = document.getElementById('bank').value.trim();
    const toEmail = document.getElementById('toEmail').value.trim() || 'orders@example.com';
    if (!company || !person || !phone || !email) {
      alert('会社名・担当者名・電話番号・メールは必須です');
      return;
    }
    const cart = getCart();
    if (cart.length === 0) {
      alert('カートが空です');
      return;
    }
    let body = [];
    body.push(`会社名: ${company}`);
    body.push(`担当者名: ${person}`);
    body.push(`電話番号: ${phone}`);
    body.push(`メール: ${email}`);
    if (address) body.push(`会社住所: ${address}`);
    if (delivery) body.push(`納品場所: ${delivery}`);
    body.push('');
    body.push('【注文内容】');
    cart.forEach(i => {
      const nameDisplay = i.size ? `${i.name} (${i.size})` : i.name;
      body.push(`・${nameDisplay} / 単価 ${i.price} / 数量 ${i.qty} / 小計 ${i.price * i.qty}`);
    });
    body.push(`合計: ${total(cart)} 円`);
    body.push('');
    // 決済方法の表記は不要となったため削除。
    body.push(`振込先: ${bank}`);
    const subject = `【注文】${company} / ${person}`;
    const mail1 = 'mailto:' + encodeURIComponent(toEmail) +
      '?subject=' + encodeURIComponent(subject) +
      '&body=' + encodeURIComponent(body.join('\n'));
    // 1件目の注文メール（担当者宛）を生成。ページ遷移せずに開くため window.open を使用
    window.open(mail1, '_blank');
    // 続けてお客様にも自動返信メールを作成
    const customerSubject = 'ご注文ありがとうございます';
    const customerBody = 'この度はご注文ありがとうございます。\nご入金後に商品の手配を開始いたしますので、しばらくお待ちください。';
    const mail2 = 'mailto:' + encodeURIComponent(email) +
      '?subject=' + encodeURIComponent(customerSubject) +
      '&body=' + encodeURIComponent(customerBody);
    // 別ウィンドウで開くように少し待ってから処理
    setTimeout(() => {
      window.open(mail2, '_blank');
    }, 500);
  }

  // 画像ファイル読込
  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // サイズ行を追加
  function addSizeRow() {
    const wrapper = document.getElementById('sizes-wrapper');
    if (!wrapper) return;
    const div = document.createElement('div');
    div.className = 'size-row';
    div.innerHTML = `<input type="text" class="size-name" placeholder="サイズ（例：S）"><input type="number" class="size-price" min="0" step="1" placeholder="価格">`;
    wrapper.appendChild(div);
  }

  // 商品追加
  function handleAddProduct() {
    const name = document.getElementById('product-name').value.trim();
    const desc = document.getElementById('product-desc').value.trim();
    const price = Number(document.getElementById('product-price').value);
    const fileInput = document.getElementById('product-image');
    if (!name) {
      alert('商品名を入力してください');
      return;
    }
    if (!price) {
      alert('価格を入力してください');
      return;
    }
    // サイズ情報を収集
    const rows = document.querySelectorAll('#sizes-wrapper .size-row');
    const sizes = [];
    rows.forEach(row => {
      const sName = row.querySelector('.size-name').value.trim();
      const sPrice = Number(row.querySelector('.size-price').value);
      if (sName && sPrice) {
        sizes.push({ label: sName, price: sPrice });
      }
    });
    const done = imgSrc => {
      products.push({ name, description: desc, price, unit: '', image: imgSrc || PLACEHOLDER, sizes });
      saveProducts();
      renderCatalog();
      document.getElementById('product-name').value = '';
      document.getElementById('product-desc').value = '';
      document.getElementById('product-price').value = '';
      document.getElementById('product-image').value = '';
      document.getElementById('sizes-wrapper').innerHTML = '';
      flash('商品を登録しました');
    };
    const file = fileInput && fileInput.files && fileInput.files[0];
    if (file) {
      readFileAsDataURL(file).then(data => done(data)).catch(() => done(PLACEHOLDER));
    } else {
      done(PLACEHOLDER);
    }
  }

  // カタログを描画
  function renderCatalog() {
    const container = document.getElementById('catalog');
    if (!container) return;
    const q = normalize(document.getElementById('search')?.value || '');
    let html = '';
    products.forEach((p, idx) => {
      // 検索フィルタ
      if (q) {
        const text = normalize(p.name) + normalize(p.description);
        if (!text.includes(q)) return;
      }
      // サイズ選択
      let sizeSelect = '';
      if (p.sizes && p.sizes.length > 0) {
        sizeSelect += '<select class="size-select">';
        p.sizes.forEach(s => {
          sizeSelect += `<option value="${s.label}">${s.label} - ${fmt(s.price)}</option>`;
        });
        sizeSelect += '</select>';
      }
      html += '<div class="card item">';
      html += `<img src="${p.image}" alt="${p.name}">`;
      html += `<div class="name">${p.name}</div>`;
      html += `<div>${p.description}</div>`;
      html += `<div class="price">${fmt(p.price)}${p.unit ? ' / ' + p.unit : ''}</div>`;
      html += '<div class="controls">';
      if (sizeSelect) html += sizeSelect;
      html += '<input type="number" min="1" value="1" class="qty">';
      html += `<button type="button" class="success" data-action="add-to-cart" data-index="${idx}">カートに追加</button>`;
      html += '</div>';
      html += '</div>';
    });
    container.innerHTML = html;
  }

  // カートを描画
  function renderCart() {
    const c = getCart();
    const count = c.reduce((s, i) => s + i.qty, 0);
    const headCount = document.getElementById('cart-count');
    const headTotal = document.getElementById('cart-total');
    if (headCount) headCount.textContent = count;
    if (headTotal) headTotal.textContent = fmt(total(c));
    const list = document.getElementById('cart-list');
    if (!list) return;
    if (c.length === 0) {
      list.innerHTML = '<div>カートは空です。</div>';
      document.getElementById('cart-total-bottom').textContent = fmt(0);
      return;
    }
    let html = '';
    c.forEach(i => {
      const nameDisplay = i.size ? `${i.name} (${i.size})` : i.name;
      html += '<div class="row">';
      html += `<div><span class="badge">${i.qty}</span> ${nameDisplay}</div>`;
      html += `<div>${fmt(i.price)}</div>`;
      html += `<div><input type="number" min="1" value="${i.qty}" data-qty data-name="${i.name}" data-price="${i.price}" data-size="${i.size || ''}"></div>`;
      html += `<div>${fmt(i.price * i.qty)}</div>`;
      html += `<div><button class="danger" data-remove data-name="${i.name}" data-price="${i.price}" data-size="${i.size || ''}">削除</button></div>`;
      html += '</div>';
    });
    list.innerHTML = html;
    document.getElementById('cart-total-bottom').textContent = fmt(total(c));
  }

  // ショップとチェックアウト画面の切り替え
  function showCheckout() {
    const shop = document.getElementById('shop-view');
    const check = document.getElementById('checkout-view');
    if (shop) shop.style.display = 'none';
    if (check) check.style.display = '';
    // スクロールをトップに
    window.scrollTo(0, 0);
    // チェックアウトに入る際にはカート内容を再描画
    renderCart();
    // ヘッダの「カートを見る」ボタンを非表示
    const btnCheckout = document.getElementById('btn-checkout');
    if (btnCheckout) btnCheckout.style.display = 'none';
  }
  function hideCheckout() {
    const shop = document.getElementById('shop-view');
    const check = document.getElementById('checkout-view');
    if (check) check.style.display = 'none';
    if (shop) shop.style.display = '';
    window.scrollTo(0, 0);
    // 戻る際にもカート数等を再描画
    renderCart();
    // ヘッダの「カートを見る」ボタンを表示
    const btnCheckout = document.getElementById('btn-checkout');
    if (btnCheckout) btnCheckout.style.display = '';
  }

  // 初期化
  document.addEventListener('DOMContentLoaded', () => {
    loadProducts();
    renderCatalog();
    renderCart();
    // URL パラメータを確認し、管理者モードなら商品追加フォームを表示
    const params = new URLSearchParams(window.location.search);
    if (params.get('admin') === '1') {
      const card = document.getElementById('product-form-card');
      if (card) card.style.display = '';
    }
    // 商品登録
    document.getElementById('btn-add-product').addEventListener('click', handleAddProduct);
    // サイズ追加
    document.getElementById('add-size').addEventListener('click', e => { addSizeRow(); e.preventDefault(); });
    // 検索
    document.getElementById('search').addEventListener('input', () => { renderCatalog(); });
  });

  // 全体のクリックイベントをデリゲート
  document.addEventListener('click', ev => {
    const t = ev.target;
    // カートに追加
    const addBtn = t.closest('[data-action="add-to-cart"]');
    if (addBtn) {
      const idx = Number(addBtn.dataset.index);
      const product = products[idx];
      const itemEl = addBtn.closest('.item');
      const qtyInput = itemEl.querySelector('.qty');
      const qtyVal = Number(qtyInput && qtyInput.value) || 1;
      let selectedSize = '';
      let price = product.price;
      const sel = itemEl.querySelector('.size-select');
      if (sel) {
        selectedSize = sel.value;
        const found = product.sizes.find(s => s.label === selectedSize);
        if (found) price = found.price;
      }
      addToCart(product.name, price, qtyVal, selectedSize);
      ev.preventDefault();
      return;
    }
    // 削除
    if (t.closest('[data-remove]')) {
      const name = t.dataset.name;
      const price = t.dataset.price;
      const size = t.dataset.size || '';
      removeItem(name, price, size);
      ev.preventDefault();
      return;
    }
    // 数量更新
    if (t.closest('[data-qty]')) {
      const input = t.closest('[data-qty]');
      const name = input.dataset.name;
      const price = input.dataset.price;
      const size = input.dataset.size || '';
      updateQty(name, price, size, input.value);
      return;
    }
    // カート空
    if (t.closest('#btn-clear')) {
      clearCart();
      ev.preventDefault();
      return;
    }
    // チェックアウト画面を表示
    if (t.closest('#btn-checkout')) {
      // カートが空ならアラート
      if (getCart().length === 0) {
        alert('カートが空です');
      } else {
        showCheckout();
      }
      ev.preventDefault();
      return;
    }
    // チェックアウト画面から戻る
    if (t.closest('#btn-back')) {
      hideCheckout();
      ev.preventDefault();
      return;
    }
    // 地図
    if (t.closest('#btn-map')) {
      updateMap();
      ev.preventDefault();
      return;
    }
    // 注文送信
    if (t.closest('#btn-send')) {
      // メール送信は外部アクションなので、ユーザー確認を促す
      if (confirm('メールソフトを起動して注文メールを作成しますか？')) {
        sendEmailOrder();
      }
      ev.preventDefault();
      return;
    }
  });
})();
</script>
</body>
</html>