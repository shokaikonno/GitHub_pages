<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>今野商会</title>
  <!-- このファイルは CSS と JS を内包した単一のページです。ブラウザでこの HTML を開くだけで動作します。 -->
  <style>
    /* ===== 全体のレイアウト ===== */
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; margin: 0; background: #f6f7fb; color: #222; }
    header { position: sticky; top: 0; background: #1f2937; color: #fff; padding: 10px 16px; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,.2); }
    header .row { display: flex; align-items: center; gap: 12px; }
    header h1 { font-size: 18px; margin: 0; }
    header .spacer { flex: 1; }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 360px; gap: 16px; }
    @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }

    /* チェックアウト画面では左カラムのみ表示するため、shop-view の grid は 1 カラムにする */
    #shop-view.grid-2 { grid-template-columns: 1fr; }
    .card { background: #fff; border-radius: 12px; padding: 12px; box-shadow: 0 1px 4px rgba(0,0,0,.08); }
    h2 { font-size: 16px; margin: 8px 0 12px; }
    .catalog { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px,1fr)); gap: 12px; }
    .item { display: flex; flex-direction: column; gap: 6px; }
    .item img { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; background:#e5e7eb; }
    .item .name { font-weight: 700; }
    .item .price { font-weight: 700; }
    .controls { display:flex; gap: 8px; align-items: center; margin-top: 6px; }
    .controls input[type=number]{ width: 80px; padding: 6px; border:1px solid #cfd8dc; border-radius: 8px; }
    button { padding: 8px 10px; border:0; border-radius: 8px; cursor:pointer; }
    button.primary { background: #2563eb; color:#fff; }
    button.success { background: #16a34a; color: #fff; }
    button.gray { background: #374151; color:#fff; }
    button.danger { background: #dc2626; color:#fff; }
    button.secondary { background: #4b5563; color:#fff; }
    /* ===== 商品詳細モーダル ===== */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); z-index: 20; }
    .modal-content { background: #fff; border-radius: 12px; max-width: 600px; width: 90%; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,.3); }
    .modal-content img { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; background:#e5e7eb; }
    .modal-content h3 { margin: 8px 0; font-size: 18px; }
    .modal-content .desc { margin: 8px 0; color:#555; }
    .modal-content .actions { display:flex; gap:8px; margin-top:12px; }
    .modal-close { position: absolute; top: 16px; right: 16px; cursor: pointer; font-size: 24px; color:#374151; }

    /* モーダル内でクロスボタンを正しく表示するために relative 指定 */
    .modal-content { position: relative; }
    .badge { background:#eef2ff; padding:2px 6px; border-radius:999px; font-size: 12px; }
    .cart-list .row { display:grid; grid-template-columns: 1fr auto auto auto auto; gap: 6px; align-items: center; margin: 6px 0; }
    .cart-list input[type=number] { width:80px; padding:6px; border:1px solid #cfd8dc; border-radius:8px; }
    .total { font-size: 18px; font-weight: 800; }
    .field { display:flex; flex-direction: column; gap: 4px; margin-bottom: 8px; }
    input[type=text], input[type=email], input[type=tel], textarea, input[type=number] { padding: 8px; border:1px solid #cfd8dc; border-radius: 8px; width: 100%; }
    textarea { min-height: 60px; }
    .small { font-size: 12px; color:#555; }
    .map { width: 100%; height: 260px; border: 0; border-radius: 10px; background:#e5e7eb; }
    footer { padding: 16px; text-align:center; color:#555; font-size: 12px; }
    /* 商品追加フォーム内のサイズ行 */
    #sizes-wrapper .size-row { display: flex; gap: 8px; margin-bottom: 4px; }
    #sizes-wrapper .size-row input[type=text],
    #sizes-wrapper .size-row input[type=number] { flex: 1; padding: 6px; border: 1px solid #cfd8dc; border-radius: 8px; }
    /* サイズ追加ボタンのレイアウトを調整 */
    #add-size { margin-top: 4px; }

    /* ===== 商品詳細ページ ===== */
    #product-view { display: none; }
    #product-view .prod-card { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,.1); }
    /* 詳細ページレイアウト：画像と情報を横並びに */
    #product-view .prod-grid { display: flex; gap: 16px; flex-wrap: wrap; }
    #product-view .prod-img-wrapper { flex: 1 1 40%; max-width: 400px; }
    #product-view .prod-info { flex: 1 1 50%; min-width: 220px; }
    #product-view img { width: 100%; height: auto; object-fit: contain; border-radius: 8px; background:#e5e7eb; }
    #product-view h2 { font-size: 20px; margin: 0 0 8px 0; }
    #product-view .desc { margin: 8px 0; color:#555; white-space: pre-wrap; }
    #product-view .actions { display:flex; gap:8px; margin-top:12px; }
    /* 小さい画面では縦並び */
    @media (max-width: 700px) {
      #product-view .prod-grid { flex-direction: column; }
      #product-view .prod-img-wrapper, #product-view .prod-info { flex: 1 1 100%; max-width: none; }
    }

    /* おすすめ商品の表示 */
    #prod-recommend { margin-top: 24px; }
    #prod-recommend h3 { margin: 0 0 8px 0; font-size: 18px; }
    #prod-recommend .recommend-list { display: flex; gap: 12px; overflow-x: auto; }
    #prod-recommend .rec-item { min-width: 160px; background: #f9fafb; padding: 8px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,.05); }
    #prod-recommend .rec-item img { width: 100%; height: 80px; object-fit: cover; border-radius: 4px; background:#e5e7eb; }
    #prod-recommend .rec-item .name { font-size: 14px; font-weight: 600; margin-top:4px; }
    #prod-recommend .rec-item .price { font-size: 12px; color:#666; margin-top:2px; }
    #prod-recommend .rec-item button { margin-top: 4px; width:100%; padding:4px; font-size:12px; }
  </style>
</head>
<body>
<header>
  <div class="row">
    <h1>今野商会</h1>
    <div class="spacer"></div>
    <!-- カート合計をヘッダーに表示 -->
    <div style="display:flex;align-items:center;gap:8px;">
      <span>カート：<span id="cart-count">0</span> 点 / <span id="cart-total">¥0</span></span>
      <button id="btn-checkout" type="button" class="primary" style="padding:4px 8px;">カートを見る</button>
    </div>
  </div>
</header>

<div id="shop-view" class="container grid-2">
  <!-- 左カラム：カタログと商品追加 -->
  <div>
    <!-- カタログ -->
    <div class="card">
      <h2>カタログ</h2>
      <!-- 検索フォームと並び替え -->
      <div class="field" style="margin-bottom: 8px; display:flex; gap:8px; flex-wrap:wrap;">
        <input id="search" type="text" placeholder="商品を検索..." style="flex:1;">
        <select id="sort" style="padding:8px;border:1px solid #cfd8dc;border-radius:8px;">
          <option value="default">並び替え</option>
          <option value="priceAsc">価格の安い順</option>
          <option value="priceDesc">価格の高い順</option>
          <option value="nameAsc">名前順 (A→Z)</option>
        </select>
      </div>
      <div id="catalog" class="catalog"></div>
    </div>
    <!-- 商品追加フォーム（管理者用）
         URL に ?admin=1023 を付けた場合のみ表示されます。
         デフォルトでは非表示にして、一般の顧客がアクセスした際には商品追加が出来ないようにします。-->
    <div id="product-form-card" class="card" style="margin-top: 16px; display: none;">
      <h2>商品を追加</h2>
      <div class="field"><label>商品名 *</label><input id="product-name" type="text" placeholder="例：塩ビパイプ (VP13)"></div>
      <div class="field"><label>説明</label><textarea id="product-desc" placeholder="商品の説明を入力"></textarea></div>
      <div class="field"><label>価格 *</label><input id="product-price" type="number" min="0" step="1" placeholder="価格"></div>
      <div class="field"><label>画像</label><input id="product-image" type="file" accept="image/*"></div>
      <div class="field"><label>サイズと価格</label>
        <div id="sizes-wrapper">
          <!-- 初期のサイズ入力行は空。必要に応じて追加します -->
        </div>
        <button id="add-size" type="button" class="secondary">サイズを追加</button>
      </div>
      <div class="field">
        <button id="btn-add-product" type="button" class="primary">商品を登録</button>
      </div>
      <div class="small">※サイズが不要な場合は空欄のままで構いません。</div>
    </div>
  </div>
  <!-- 右カラムはチェックアウト画面に移動しました -->
</div>
<!-- チェックアウトビュー：カート内容と注文情報を表示 -->
<div id="checkout-view" style="display:none;">
  <div class="container">
    <!-- カート一覧 -->
    <div class="card">
      <h2>カート</h2>
      <div id="cart-list" class="cart-list"></div>
      <hr>
      <div class="row total">合計：<span id="cart-total-bottom">¥0</span></div>
      <div style="margin-top:8px;display:flex;gap:8px;">
        <button id="btn-clear" type="button" class="danger">カートを空にする</button>
        <button id="btn-back" type="button" class="secondary">戻る</button>
      </div>
    </div>
    <!-- 注文情報フォーム -->
    <div class="card" style="margin-top:12px;">
      <h2>注文情報</h2>
      <div class="field"><label>会社名 *</label><input id="company" type="text" required></div>
      <div class="field"><label>担当者名 *</label><input id="person" type="text" required></div>
      <div class="field"><label>電話番号 *</label><input id="phone" type="tel" required></div>
      <div class="field"><label>メールアドレス *</label><input id="email" type="email" required></div>
      <div class="field"><label>会社住所</label><input id="address" type="text"></div>
      <div class="field"><label>納品場所（住所や目印）</label><input id="delivery" type="text" placeholder="例：埼玉県熊谷市〇〇1-2-3 〇〇ビル3F"></div>
      <div class="field"><button id="btn-map" type="button" class="gray">地図を表示</button></div>
      <iframe id="map" class="map"></iframe>
      <hr>
      <!-- 振込先はGitHub Pagesで公開しないためフォームから削除 -->
      <!-- <div class="field"><label>振込先（固定）</label><input id="bank" type="text" value="住信ＳＢＩネット銀行 法人第一支店 普通2262610" readonly></div> -->
      <div class="field"><label>注文メールの宛先（固定）</label><input id="toEmail" type="email" value="takato@konnoshokai.co.jp" readonly></div>
      <div style="margin-top:8px;display:flex;gap:8px;"><button id="btn-send" type="button" class="primary">メールで注文送信</button></div>
      <div class="small">※ボタンを押すと、お使いのメールソフトが起動します。ご入金確認後に手配します。</div>
    </div>
  </div>
</div>
<!-- フラッシュメッセージ -->
<div id="flash" style="position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#111;color:#fff;padding:8px 12px;border-radius:8px;opacity:0;transition:.3s;"></div>
<footer>© B2B EC – Single File Edition</footer>

<!-- 商品詳細ビュー -->
<div id="product-view">
  <div class="container">
    <div class="prod-card">
      <div style="margin-bottom:8px;">
        <button id="btn-back-catalog" type="button" class="secondary">戻る</button>
      </div>
      <!-- 詳細ページのレイアウトを画像と情報に分割 -->
      <div class="prod-grid">
        <div class="prod-img-wrapper">
          <img id="prod-image" src="" alt="">
        </div>
        <div class="prod-info">
          <h2 id="prod-name"></h2>
          <div id="prod-desc" class="desc"></div>
          <div id="prod-price" class="price"></div>
          <div id="prod-size-wrapper" style="margin-top:8px;"></div>
          <div class="actions">
            <input id="prod-qty" type="number" min="1" value="1" style="width:80px;padding:6px;border:1px solid #cfd8dc;border-radius:8px;">
            <button id="prod-add" type="button" class="success">カートに追加</button>
          </div>
        </div>
      </div>
      <!-- おすすめ商品 -->
      <div id="prod-recommend">
        <h3>おすすめ商品</h3>
        <div class="recommend-list" id="recommend-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- 商品詳細モーダル -->
<div id="modal" class="modal">
  <div class="modal-content">
    <span id="modal-close" class="modal-close">&times;</span>
    <img id="modal-img" src="" alt="">
    <h3 id="modal-name"></h3>
    <div class="desc" id="modal-desc"></div>
    <div id="modal-price" class="price"></div>
    <div id="modal-size-wrapper"></div>
    <div class="actions">
      <input type="number" id="modal-qty" min="1" value="1" style="width:80px;padding:6px;border:1px solid #cfd8dc;border-radius:8px;">
      <button id="modal-add" type="button" class="success">カートに追加</button>
    </div>
  </div>
</div>

<!-- アプリケーションロジック -->
<script>
(() => {
  /* ===== プレースホルダー画像（ベース64） ===== */
  const PLACEHOLDER = 'data:image/png;base64,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';

  /* ===== ストレージキーの定義 ===== */
  const STORAGE_CART_KEY = 'b2bCart_spa_v3';
  const STORAGE_PRODUCTS_KEY = 'b2bProducts_spa_v3';

  // 現在編集中の商品インデックス（null の場合は新規追加）
  let editingIndex = null;

  /* ===== ローカルストレージ判定 ===== */
  function storageAvailable() {
    try {
      const x = '__storage_test__';
      localStorage.setItem(x, x);
      localStorage.removeItem(x);
      return true;
    } catch (e) {
      return false;
    }
  }
  const useLocal = storageAvailable();

  // ===== 管理者モードの判定 =====
  // URL に ?admin=1023 が含まれている場合は管理者モードとみなす。
  const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1023';

  /* ===== 初期商品データ ===== */
  let products = [
    { name: '室外機（2.8kW）', description: '壁掛けエアコン用室外機。', price: 35000, unit: '台', image: 'https://shokaikonno.github.io/GitHub_pages/images/41dLFXPNneL._AC_SX679_.jpg', sizes: [] },
    { name: '冷媒配管セット（5m）', description: '配管と断熱材のセット。', price: 6000, unit: 'セット', image: PLACEHOLDER, sizes: [] },
    { name: '高効率給湯器（エコキュート）', description: 'ヒートポンプ式高効率給湯器。', price: 200000, unit: '台', image: PLACEHOLDER, sizes: [] },
    { name: '洗面台ユニット', description: '収納付き洗面台セット。', price: 45000, unit: '台', image: PLACEHOLDER, sizes: [] },
    { name: 'システムキッチンシンク', description: 'ステンレス製キッチンシンク。', price: 60000, unit: '台', image: PLACEHOLDER, sizes: [] }
  ];

  /* ===== 補助関数 ===== */
  // 数字を通貨表記に
  function fmt(val) {
    return '¥' + Number(val).toLocaleString();
  }

  // 日本語文字列を検索用に正規化
  function normalize(str) {
    str = (str || '').toString().trim().toLowerCase();
    // 全角英数字を半角へ
    str = str.replace(/[０-９Ａ-Ｚａ-ｚ]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
    // カタカナをひらがなへ
    str = str.replace(/[\u30a1-\u30f6]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));
    // 空白類を削除
    return str.replace(/\s+/g, '');
  }

  // 商品データを保存／読み込み
  function loadProducts() {
    if (useLocal) {
      try {
        const stored = localStorage.getItem(STORAGE_PRODUCTS_KEY);
        if (stored) {
          products = JSON.parse(stored);
          return;
        }
      } catch (e) {}
      // 初期値を保存
      try {
        localStorage.setItem(STORAGE_PRODUCTS_KEY, JSON.stringify(products));
      } catch (e) {}
    }
  }
  function saveProducts() {
    if (useLocal) {
      try {
        localStorage.setItem(STORAGE_PRODUCTS_KEY, JSON.stringify(products));
      } catch (e) {}
    }
  }

  // 商品データを追加フォームに読み込む（管理者向け編集）
  function loadProductToForm(idx) {
    editingIndex = idx;
    const p = products[idx];
    if (!p) return;
    // フォームの表示
    const card = document.getElementById('product-form-card');
    if (card) card.style.display = '';
    // フィールドに値を設定
    document.getElementById('product-name').value = p.name;
    document.getElementById('product-desc').value = p.description || '';
    document.getElementById('product-price').value = p.price;
    // 画像は編集しない場合もあるので初期化しない
    // サイズを再構築
    const wrapper = document.getElementById('sizes-wrapper');
    wrapper.innerHTML = '';
    if (p.sizes && p.sizes.length > 0) {
      p.sizes.forEach(s => {
        addSizeRow(s.label, s.price);
      });
    }
    // ボタンラベルを変更
    const btn = document.getElementById('btn-add-product');
    if (btn) btn.textContent = '商品を更新';
    // スクロール
    card.scrollIntoView({ behavior: 'smooth' });
  }

  // カート取得／保存
  function getCart() {
    if (useLocal) {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_CART_KEY)) || [];
      } catch (e) { return []; }
    }
    return window.memoryCart || [];
  }
  function setCart(c) {
    if (useLocal) {
      localStorage.setItem(STORAGE_CART_KEY, JSON.stringify(c));
    } else {
      window.memoryCart = c;
    }
  }

  // 商品を削除（管理者専用）
  // 指定したインデックスの商品を products 配列から削除し、ストレージに反映する
  function deleteProduct(index) {
    // 管理者確認を促す
    if (!confirm('この商品を削除しますか？')) return;
    // 有効なインデックスか確認
    if (index < 0 || index >= products.length) return;
    products.splice(index, 1);
    saveProducts();
    renderCatalog();
  }

  // 商品詳細ページを表示
  function showProductView(idx) {
    const p = products[idx];
    if (!p) return;
    // 隠す/表示
    const shop = document.getElementById('shop-view');
    const checkout = document.getElementById('checkout-view');
    const pview = document.getElementById('product-view');
    if (shop) shop.style.display = 'none';
    if (checkout) checkout.style.display = 'none';
    if (pview) pview.style.display = 'block';
    // コンテンツを設定
    document.getElementById('prod-image').src = p.image || PLACEHOLDER;
    document.getElementById('prod-image').alt = p.name;
    document.getElementById('prod-name').textContent = p.name;
    document.getElementById('prod-desc').textContent = p.description || '';
    // サイズセレクト
    const sizeWrap = document.getElementById('prod-size-wrapper');
    sizeWrap.innerHTML = '';
    const priceEl = document.getElementById('prod-price');
    // デフォルト価格表示
    if (p.sizes && p.sizes.length > 0) {
      let html = '<select id="prod-size" style="width:100%;padding:8px;border:1px solid #cfd8dc;border-radius:8px;">';
      p.sizes.forEach(s => {
        html += `<option value="${s.label}" data-price="${s.price}">${s.label} - ${fmt(s.price)}</option>`;
      });
      html += '</select>';
      sizeWrap.innerHTML = html;
      const sel = document.getElementById('prod-size');
      const updatePrice = () => {
        const opt = sel.selectedOptions[0];
        const pr = opt ? Number(opt.getAttribute('data-price')) : p.price;
        priceEl.textContent = fmt(pr) + (p.unit ? ' / ' + p.unit : '');
      };
      sel.addEventListener('change', updatePrice);
      updatePrice();
    } else {
      priceEl.textContent = fmt(p.price) + (p.unit ? ' / ' + p.unit : '');
    }
    // 数量初期化
    document.getElementById('prod-qty').value = 1;
    // ボタンにインデックスを保持
    const addBtn = document.getElementById('prod-add');
    addBtn.dataset.index = idx;

    // おすすめ商品の生成：別の商品から最大3件を表示
    const recList = document.getElementById('recommend-list');
    if (recList) {
      recList.innerHTML = '';
      // 他の商品を取得
      const others = products.map((p2, i2) => ({ item: p2, index: i2 })).filter(obj => obj.index !== idx);
      // シャッフルして上位3件
      for (let i = others.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [others[i], others[j]] = [others[j], others[i]];
      }
      const recommends = others.slice(0, 3);
      recommends.forEach(obj => {
        const rp = obj.item;
        const ri = obj.index;
        const div = document.createElement('div');
        div.className = 'rec-item';
        div.innerHTML = `<img src="${rp.image}" alt="${rp.name}"><div class="name">${rp.name}</div><div class="price">${fmt(rp.price)}${rp.unit ? ' / ' + rp.unit : ''}</div><button type="button" class="secondary" data-action="rec-detail" data-index="${ri}">詳細</button>`;
        recList.appendChild(div);
      });
    }
  }

  // 商品詳細ページから戻る
  function hideProductView() {
    const pview = document.getElementById('product-view');
    const shop = document.getElementById('shop-view');
    if (pview) pview.style.display = 'none';
    if (shop) shop.style.display = '';
    // スクロール位置をトップへ
    window.scrollTo(0, 0);
  }

  // 商品詳細モーダルを表示
  function openProductDetail(idx) {
    const p = products[idx];
    if (!p) return;
    const modal = document.getElementById('modal');
    if (!modal) return;
    // 画像
    const imgEl = document.getElementById('modal-img');
    imgEl.src = p.image || PLACEHOLDER;
    imgEl.alt = p.name;
    // 名称と説明
    document.getElementById('modal-name').textContent = p.name;
    document.getElementById('modal-desc').textContent = p.description || '';
    // サイズセレクトを作成
    const sizeWrapper = document.getElementById('modal-size-wrapper');
    sizeWrapper.innerHTML = '';
    const priceEl = document.getElementById('modal-price');
    // 初期価格表示
    let basePrice = p.price;
    if (p.sizes && p.sizes.length > 0) {
      let html = '<select id="modal-size" style="width:100%;padding:8px;border:1px solid #cfd8dc;border-radius:8px;margin-top:8px;">';
      p.sizes.forEach(s => {
        html += `<option value="${s.label}" data-price="${s.price}">${s.label} - ${fmt(s.price)}</option>`;
      });
      html += '</select>';
      sizeWrapper.innerHTML = html;
      const sel = document.getElementById('modal-size');
      // 更新関数
      const updatePrice = () => {
        const opt = sel.selectedOptions[0];
        const pr = opt ? Number(opt.getAttribute('data-price')) : p.price;
        priceEl.textContent = fmt(pr) + (p.unit ? ' / ' + p.unit : '');
      };
      sel.addEventListener('change', updatePrice);
      updatePrice();
    } else {
      // サイズなしの場合
      priceEl.textContent = fmt(p.price) + (p.unit ? ' / ' + p.unit : '');
    }
    // 数量初期化
    document.getElementById('modal-qty').value = 1;
    // ボタンにインデックスを設定
    const addBtn = document.getElementById('modal-add');
    addBtn.dataset.index = idx;
    // 表示
    modal.style.display = 'flex';
  }
  // モーダルを閉じる
  function closeModal() {
    const modal = document.getElementById('modal');
    if (modal) modal.style.display = 'none';
    // イベントリスナーをクリーンアップ（サイズセレクトを削除することで自動解放）
    const sel = document.getElementById('modal-size');
    if (sel) {
      // Clone to remove listeners
      const clone = sel.cloneNode(true);
      sel.parentNode.replaceChild(clone, sel);
    }
  }
  // カートに追加
  function addToCart(name, price, qty, size = '') {
    qty = Math.max(1, Number(qty || 1));
    price = Number(price || 0);
    const c = getCart();
    const idx = c.findIndex(x => x.name === name && Number(x.price) === price && (x.size || '') === (size || ''));
    if (idx >= 0) {
      c[idx].qty += qty;
    } else {
      c.push({ name, price, qty, size });
    }
    setCart(c);
    renderCart();
    flash('カートに追加しました');
  }

  // 数量変更
  function updateQty(name, price, size, qty) {
    qty = Math.max(1, Number(qty || 1));
    const c = getCart();
    const idx = c.findIndex(x => x.name === name && Number(x.price) === Number(price) && (x.size || '') === (size || ''));
    if (idx >= 0) {
      c[idx].qty = qty;
      setCart(c);
      renderCart();
    }
  }
  // 削除
  function removeItem(name, price, size) {
    let c = getCart().filter(x => !(x.name === name && Number(x.price) === Number(price) && (x.size || '') === (size || '')));
    setCart(c);
    renderCart();
  }
  // カートを空に
  function clearCart() {
    setCart([]);
    renderCart();
  }
  // 合計計算
  function total(c = getCart()) {
    return c.reduce((s, i) => s + Number(i.price) * Number(i.qty), 0);
  }

  // フラッシュメッセージ
  function flash(msg) {
    const el = document.getElementById('flash');
    if (!el) return;
    el.textContent = msg;
    el.style.opacity = 1;
    setTimeout(() => { el.style.opacity = 0; }, 1200);
  }

  // 地図更新
  function updateMap() {
    const q = document.getElementById('delivery').value.trim();
    if (!q) {
      alert('納品場所を入力してください');
      return;
    }
    const src = `https://www.google.com/maps?q=${encodeURIComponent(q)}&z=16&output=embed`;
    document.getElementById('map').src = src;
  }

  // 注文メール送信
  function sendEmailOrder() {
    const company = document.getElementById('company').value.trim();
    const person = document.getElementById('person').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const email = document.getElementById('email').value.trim();
    const address = document.getElementById('address').value.trim();
    const delivery = document.getElementById('delivery').value.trim();
    // 振込先は公開しないため取得しない
    const bank = '';
    const toEmail = document.getElementById('toEmail').value.trim() || 'orders@example.com';
    if (!company || !person || !phone || !email) {
      alert('会社名・担当者名・電話番号・メールは必須です');
      return;
    }
    const cart = getCart();
    if (cart.length === 0) {
      alert('カートが空です');
      return;
    }
    let body = [];
    body.push(`会社名: ${company}`);
    body.push(`担当者名: ${person}`);
    body.push(`電話番号: ${phone}`);
    body.push(`メール: ${email}`);
    if (address) body.push(`会社住所: ${address}`);
    if (delivery) body.push(`納品場所: ${delivery}`);
    body.push('');
    body.push('【注文内容】');
    cart.forEach(i => {
      const nameDisplay = i.size ? `${i.name} (${i.size})` : i.name;
      body.push(`・${nameDisplay} / 単価 ${i.price} / 数量 ${i.qty} / 小計 ${i.price * i.qty}`);
    });
    body.push(`合計: ${total(cart)} 円`);
    body.push('');
    // 決済方法の表記は不要となったため削除。
    // 振込先はメールに記載しない
    // body.push(`振込先: ${bank}`);
    const subject = `【注文】${company} / ${person}`;
    const mail1 = 'mailto:' + encodeURIComponent(toEmail) +
      '?subject=' + encodeURIComponent(subject) +
      '&body=' + encodeURIComponent(body.join('\n'));
    // 1件目の注文メール（担当者宛）を生成。ページ遷移せずに開くため window.open を使用
    window.open(mail1, '_blank');
    // 続けてお客様にも自動返信メールを作成
    const customerSubject = 'ご注文ありがとうございます';
    const customerBody = 'この度はご注文ありがとうございます。\nご入金後に商品の手配を開始いたしますので、しばらくお待ちください。';
    const mail2 = 'mailto:' + encodeURIComponent(email) +
      '?subject=' + encodeURIComponent(customerSubject) +
      '&body=' + encodeURIComponent(customerBody);
    // 別ウィンドウで開くように少し待ってから処理
    setTimeout(() => {
      window.open(mail2, '_blank');
    }, 500);
  }

  // 画像ファイル読込
  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // サイズ行を追加
  function addSizeRow(label = '', price = '') {
    const wrapper = document.getElementById('sizes-wrapper');
    if (!wrapper) return;
    const div = document.createElement('div');
    div.className = 'size-row';
    div.innerHTML = `<input type="text" class="size-name" placeholder="サイズ（例：S）" value="${label}"><input type="number" class="size-price" min="0" step="1" placeholder="価格" value="${price}">`;
    wrapper.appendChild(div);
  }

  // 商品追加
  function handleAddProduct() {
    const name = document.getElementById('product-name').value.trim();
    const desc = document.getElementById('product-desc').value.trim();
    const price = Number(document.getElementById('product-price').value);
    const fileInput = document.getElementById('product-image');
    if (!name) {
      alert('商品名を入力してください');
      return;
    }
    if (!price) {
      alert('価格を入力してください');
      return;
    }
    // サイズ情報を収集
    const rows = document.querySelectorAll('#sizes-wrapper .size-row');
    const sizes = [];
    rows.forEach(row => {
      const sName = row.querySelector('.size-name').value.trim();
      const sPrice = Number(row.querySelector('.size-price').value);
      if (sName && sPrice) {
        sizes.push({ label: sName, price: sPrice });
      }
    });
    const done = imgSrc => {
      if (editingIndex !== null && editingIndex >= 0 && editingIndex < products.length) {
        // 既存の商品を更新
        const existing = products[editingIndex];
        existing.name = name;
        existing.description = desc;
        existing.price = price;
        existing.sizes = sizes;
        // 画像がアップロードされていれば更新
        if (imgSrc && imgSrc !== PLACEHOLDER) {
          existing.image = imgSrc;
        }
        editingIndex = null;
        flash('商品を更新しました');
      } else {
        // 新規追加
        products.push({ name, description: desc, price, unit: '', image: imgSrc || PLACEHOLDER, sizes });
        flash('商品を登録しました');
      }
      saveProducts();
      renderCatalog();
      // フォームをリセット
      document.getElementById('product-name').value = '';
      document.getElementById('product-desc').value = '';
      document.getElementById('product-price').value = '';
      document.getElementById('product-image').value = '';
      document.getElementById('sizes-wrapper').innerHTML = '';
      // ボタンラベルを元に戻す
      const btn = document.getElementById('btn-add-product');
      if (btn) btn.textContent = '商品を登録';
    };
    const file = fileInput && fileInput.files && fileInput.files[0];
    if (file) {
      readFileAsDataURL(file).then(data => done(data)).catch(() => done(PLACEHOLDER));
    } else {
      done(PLACEHOLDER);
    }
  }

  // カタログを描画
  function renderCatalog() {
    const container = document.getElementById('catalog');
    if (!container) return;
    const q = normalize(document.getElementById('search')?.value || '');
    let html = '';
    // 並び替え設定
    let sorted = products.map((p, i) => ({ ...p, _idx: i }));
    const sortSelect = document.getElementById('sort');
    const sortVal = sortSelect ? sortSelect.value : 'default';
    if (sortVal === 'priceAsc') {
      sorted.sort((a, b) => a.price - b.price);
    } else if (sortVal === 'priceDesc') {
      sorted.sort((a, b) => b.price - a.price);
    } else if (sortVal === 'nameAsc') {
      sorted.sort((a, b) => a.name.localeCompare(b.name));
    }
    sorted.forEach(item => {
      const p = item;
      const idx = p._idx;
      // 検索フィルタ
      if (q) {
        const text = normalize(p.name) + normalize(p.description);
        if (!text.includes(q)) return;
      }
      // サイズ選択
      let sizeSelect = '';
      if (p.sizes && p.sizes.length > 0) {
        sizeSelect += '<select class="size-select">';
        p.sizes.forEach(s => {
          sizeSelect += `<option value="${s.label}">${s.label} - ${fmt(s.price)}</option>`;
        });
        sizeSelect += '</select>';
      }
      html += '<div class="card item">';
      html += `<img src="${p.image}" alt="${p.name}">`;
      html += `<div class="name">${p.name}</div>`;
      html += `<div>${p.description}</div>`;
      html += `<div class="price">${fmt(p.price)}${p.unit ? ' / ' + p.unit : ''}</div>`;
      html += '<div class="controls">';
      if (sizeSelect) html += sizeSelect;
      html += '<input type="number" min="1" value="1" class="qty">';
      // 商品詳細ボタン
      html += `<button type="button" class="secondary" data-action="show-detail" data-index="${idx}">詳細</button>`;
      // カートに追加ボタン
      html += `<button type="button" class="success" data-action="add-to-cart" data-index="${idx}">カートに追加</button>`;
      // 管理者モードの場合のみ、商品編集・削除ボタンを表示
      if (isAdmin) {
        html += ` <button type="button" class="gray" data-action="edit-product" data-index="${idx}">編集</button>`;
        html += ` <button type="button" class="danger" data-action="delete-product" data-index="${idx}">削除</button>`;
      }
      html += '</div>';
      html += '</div>';
    });
    container.innerHTML = html;
  }

  // カートを描画
  function renderCart() {
    const c = getCart();
    const count = c.reduce((s, i) => s + i.qty, 0);
    const headCount = document.getElementById('cart-count');
    const headTotal = document.getElementById('cart-total');
    if (headCount) headCount.textContent = count;
    if (headTotal) headTotal.textContent = fmt(total(c));
    const list = document.getElementById('cart-list');
    if (!list) return;
    if (c.length === 0) {
      list.innerHTML = '<div>カートは空です。</div>';
      document.getElementById('cart-total-bottom').textContent = fmt(0);
      return;
    }
    let html = '';
    c.forEach(i => {
      const nameDisplay = i.size ? `${i.name} (${i.size})` : i.name;
      html += '<div class="row">';
      html += `<div><span class="badge">${i.qty}</span> ${nameDisplay}</div>`;
      html += `<div>${fmt(i.price)}</div>`;
      html += `<div><input type="number" min="1" value="${i.qty}" data-qty data-name="${i.name}" data-price="${i.price}" data-size="${i.size || ''}"></div>`;
      html += `<div>${fmt(i.price * i.qty)}</div>`;
      html += `<div><button class="danger" data-remove data-name="${i.name}" data-price="${i.price}" data-size="${i.size || ''}">削除</button></div>`;
      html += '</div>';
    });
    list.innerHTML = html;
    document.getElementById('cart-total-bottom').textContent = fmt(total(c));
  }

  // ショップとチェックアウト画面の切り替え
  function showCheckout() {
    const shop = document.getElementById('shop-view');
    const check = document.getElementById('checkout-view');
    if (shop) shop.style.display = 'none';
    if (check) check.style.display = '';
    // スクロールをトップに
    window.scrollTo(0, 0);
    // チェックアウトに入る際にはカート内容を再描画
    renderCart();
    // ヘッダの「カートを見る」ボタンを非表示
    const btnCheckout = document.getElementById('btn-checkout');
    if (btnCheckout) btnCheckout.style.display = 'none';
  }
  function hideCheckout() {
    const shop = document.getElementById('shop-view');
    const check = document.getElementById('checkout-view');
    if (check) check.style.display = 'none';
    if (shop) shop.style.display = '';
    window.scrollTo(0, 0);
    // 戻る際にもカート数等を再描画
    renderCart();
    // ヘッダの「カートを見る」ボタンを表示
    const btnCheckout = document.getElementById('btn-checkout');
    if (btnCheckout) btnCheckout.style.display = '';
  }

  // 初期化
  document.addEventListener('DOMContentLoaded', () => {
    loadProducts();
    renderCatalog();
    renderCart();
    // URL パラメータを確認し、管理者モードなら商品追加フォームを表示
    const params = new URLSearchParams(window.location.search);
    // 管理者モード (?admin=1023 の場合) のときに商品追加フォームを表示
    if (params.get('admin') === '1023') {
      const card = document.getElementById('product-form-card');
      if (card) card.style.display = '';
    }
    // 商品登録
    document.getElementById('btn-add-product').addEventListener('click', handleAddProduct);
    // サイズ追加
    document.getElementById('add-size').addEventListener('click', e => { addSizeRow(); e.preventDefault(); });
    // 検索
    document.getElementById('search').addEventListener('input', () => { renderCatalog(); });
    // 並び替え
    const sortSelect = document.getElementById('sort');
    if (sortSelect) {
      sortSelect.addEventListener('change', () => { renderCatalog(); });
    }
  });

  // 全体のクリックイベントをデリゲート
  document.addEventListener('click', ev => {
    const t = ev.target;
    // カートに追加
    const addBtn = t.closest('[data-action="add-to-cart"]');
    if (addBtn) {
      const idx = Number(addBtn.dataset.index);
      const product = products[idx];
      const itemEl = addBtn.closest('.item');
      const qtyInput = itemEl.querySelector('.qty');
      const qtyVal = Number(qtyInput && qtyInput.value) || 1;
      let selectedSize = '';
      let price = product.price;
      const sel = itemEl.querySelector('.size-select');
      if (sel) {
        selectedSize = sel.value;
        const found = product.sizes.find(s => s.label === selectedSize);
        if (found) price = found.price;
      }
      addToCart(product.name, price, qtyVal, selectedSize);
      ev.preventDefault();
      return;
    }
    // 商品詳細を表示（詳細ボタンをクリック）
    const detailBtn = t.closest('[data-action="show-detail"]');
    if (detailBtn) {
      const idx = Number(detailBtn.dataset.index);
      showProductView(idx);
      ev.preventDefault();
      return;
    }
    // おすすめ詳細からの表示
    const recBtn = t.closest('[data-action="rec-detail"]');
    if (recBtn) {
      const idx = Number(recBtn.dataset.index);
      showProductView(idx);
      ev.preventDefault();
      return;
    }
    // 商品詳細モーダルを閉じる
    if (t.closest('#modal-close')) {
      closeModal();
      ev.preventDefault();
      return;
    }
    // モーダル背景をクリックした場合も閉じる
    if (t.id === 'modal') {
      closeModal();
      ev.preventDefault();
      return;
    }
    // 商品詳細モーダルからカートへ追加
    if (t.closest('#modal-add')) {
      const addBtn = document.getElementById('modal-add');
      const idx = Number(addBtn.dataset.index);
      const p = products[idx];
      let qty = Number(document.getElementById('modal-qty').value) || 1;
      let selectedSize = '';
      let price = p.price;
      const sel = document.getElementById('modal-size');
      if (sel) {
        selectedSize = sel.value;
        const opt = sel.selectedOptions[0];
        price = opt ? Number(opt.getAttribute('data-price')) : p.price;
      }
      addToCart(p.name, price, qty, selectedSize);
      // モーダルを閉じる
      closeModal();
      ev.preventDefault();
      return;
    }
    // 商品詳細ページからカートへ追加
    if (t.closest('#prod-add')) {
      const btn = document.getElementById('prod-add');
      const idx = Number(btn.dataset.index);
      const p = products[idx];
      let qty = Number(document.getElementById('prod-qty').value) || 1;
      let selectedSize = '';
      let price = p.price;
      const sel = document.getElementById('prod-size');
      if (sel) {
        selectedSize = sel.value;
        const opt = sel.selectedOptions[0];
        price = opt ? Number(opt.getAttribute('data-price')) : p.price;
      }
      addToCart(p.name, price, qty, selectedSize);
      // カタログに戻る
      hideProductView();
      ev.preventDefault();
      return;
    }
    // 商品詳細ページから戻るボタン
    if (t.closest('#btn-back-catalog')) {
      hideProductView();
      ev.preventDefault();
      return;
    }
    // 商品削除（管理者）
    const delBtn = t.closest('[data-action="delete-product"]');
    if (delBtn) {
      const idx = Number(delBtn.dataset.index);
      deleteProduct(idx);
      ev.preventDefault();
      return;
    }
    // 商品編集（管理者）
    const editBtn = t.closest('[data-action="edit-product"]');
    if (editBtn) {
      const idx = Number(editBtn.dataset.index);
      loadProductToForm(idx);
      ev.preventDefault();
      return;
    }
    // 削除
    if (t.closest('[data-remove]')) {
      const name = t.dataset.name;
      const price = t.dataset.price;
      const size = t.dataset.size || '';
      removeItem(name, price, size);
      ev.preventDefault();
      return;
    }
    // 数量更新
    if (t.closest('[data-qty]')) {
      const input = t.closest('[data-qty]');
      const name = input.dataset.name;
      const price = input.dataset.price;
      const size = input.dataset.size || '';
      updateQty(name, price, size, input.value);
      return;
    }
    // カート空
    if (t.closest('#btn-clear')) {
      clearCart();
      ev.preventDefault();
      return;
    }
    // チェックアウト画面を表示
    if (t.closest('#btn-checkout')) {
      // カートが空ならアラート
      if (getCart().length === 0) {
        alert('カートが空です');
      } else {
        showCheckout();
      }
      ev.preventDefault();
      return;
    }
    // チェックアウト画面から戻る
    if (t.closest('#btn-back')) {
      hideCheckout();
      ev.preventDefault();
      return;
    }
    // 地図
    if (t.closest('#btn-map')) {
      updateMap();
      ev.preventDefault();
      return;
    }
    // 注文送信
    if (t.closest('#btn-send')) {
      // メール送信は外部アクションなので、ユーザー確認を促す
      if (confirm('メールソフトを起動して注文メールを作成しますか？')) {
        sendEmailOrder();
      }
      ev.preventDefault();
      return;
    }
  });
})();
</script>
</body>
</html>
